# 已知限制与待解决问题

> 本文档记录项目中已识别的设计限制和技术问题，以及改进方向。
> 遵循"事实为本"原则，诚实记录问题而非隐藏。

---

## 1. 核心逻辑问题

### 1.1 验证框架的自我循环 ⚠️ 高优先级

**问题描述**：
当前 Phase 4 学习 Phase 3 生成的轨迹数据，验证时比较 Phase 4 是否接近 Phase 3。这是一个自我循环：
- 学生 (Phase 4) 不可能超过老师 (Phase 3)
- 没有引入外部真相 (ground truth) 进行验证

**当前状态**：
```
Phase 3 (物理模型) → 生成轨迹 → Phase 4 学习
                                    ↓
                              验证: Phase 4 ≈ Phase 3?  ← 自我循环
```

**正确的框架应该是**：
```
真实经验数据 (Road Network, OD Flow, Travel Time)
           ↓
    作为共同的 Validation Target
           ↓
    ┌──────┴──────┐
    ↓             ↓
Phase 3       Phase 4
(物理模型)    (学习模型)
    ↓             ↓
    └──────┬──────┘
           ↓
    比较: 谁更接近真实数据？
```

**影响**：
- Phase 4 的价值无法被证明
- 无法判断哪个模型更好

**解决方向**：
1. 引入真实 GPS 轨迹数据作为学习目标
2. 使用 OD 流量分布作为宏观验证指标
3. 使用道路流量分布作为中观验证指标

---

### 1.2 全局导航场的目的地混合 ⚠️ 高优先级

**问题描述**：
Phase 2 计算导航场时，将所有 sink 的吸引力叠加成一个全局场。这意味着：
- 所有 agent 共享同一个"混合目的地"
- 没有建模个体的目的地选择
- 无法还原真实的 OD 分布

**验证结果**：
```
仿真目的地分布 vs 真实 OD 分布
Pearson 相关系数: -0.19 (负相关!)
```

**数学本质**：
当前导航场计算:
$$\phi(x) = \sum_{i} \frac{w_i}{1 + \alpha \cdot d_i(x)}$$

这导致所有 agent 都朝向"加权中心"移动，而非各自的独立目的地。

**解决方向**：
1. **方案 A**: 为每个 agent 采样独立的目的地 sink
2. **方案 B**: 为每个 sink 单独计算导航场，agent 运行时使用对应的场
3. **方案 C**: 将目的地选择作为 Diffusion 模型的一部分学习

---

### 1.3 固定步数仿真 vs 到达终止

**问题描述**：
当前 Phase 3 仿真使用固定步数 (10000 步)，而非"到达目的地后终止"。

**后果**：
- 行程距离统计不合理 (平均 3772 km，远超实际通勤距离)
- 约 55% 的轨迹在仿真结束时未到达 sink 10km 范围内
- 轨迹数据包含大量"已到达但继续绕行"的冗余数据

**解决方向**：
1. 添加到达终止条件 (`dist_to_sink < threshold`)
2. 或使用"到达时间"作为重要的验证指标

---

## 2. 技术实现问题

### 2.1 ZScore 归一化扭曲方向向量 ✅ 已修复

**问题描述**：
对 `nav_direction` 使用 ZScore 归一化时，y 和 x 维度的 std 不同 (0.73 vs 0.59)，导致向量角度被扭曲：
- 90° → 80.7°
- 45° → 37.5°

**修复方案**：
使用 `IdentityNormalizer` 替代 `ZScoreNormalizer` 用于 nav_direction。

**状态**：代码已修复，需要重新训练模型验证效果。

---

### 2.2 bilinear_sample 使用 round() vs int() ✅ 已修复

**问题描述**：
`physics.py` 中的 `bilinear_sample()` 使用 `round()` 取整坐标，导致部分情况下采样到相邻像素，返回错误的导航方向。

**后果**：
- 约 30% 的帧出现零速度
- velocity 与 nav_direction 的相关性下降

**修复方案**：
使用 `int()` 替代 `round()`。

**状态**：已修复，数据已重新生成。

---

### 2.3 训练日志访问 IdentityNormalizer.mean ✅ 已修复

**问题描述**：
`train.py` 日志代码尝试访问 `nav_normalizer.mean`，但 `IdentityNormalizer` 没有该属性。

**修复方案**：
添加类型检查，对 `IdentityNormalizer` 显示 `scale` 而非 `mean/std`。

**状态**：已修复。

---

## 3. 数据与验证问题

### 3.1 缺乏真实轨迹数据

**问题描述**：
没有真实的 GPS 轨迹数据作为 ground truth，只能使用物理模型生成的合成数据。

**影响**：
- Phase 4 无法学习真实人类行为
- 无法验证仿真是否符合现实

**解决方向**：
- 获取匿名化的移动轨迹数据 (如手机信令、出租车 GPS)
- 或使用公开数据集 (如 GeoLife, T-Drive)

---

### 3.2 OD 数据与仿真的尺度不匹配

**问题描述**：
OD 数据是 tract 级别 (约 2500 人口单元)，sink 是聚类后的 35 个点。这两个尺度不直接对应。

**影响**：
- 无法直接比较仿真 OD 矩阵与真实 OD 矩阵
- Sink 的 `total_flow` 权重是聚合后的近似值

---

## 4. 待验证的改进

| 改进项 | 状态 | 说明 |
|--------|------|------|
| IdentityNormalizer for nav | 代码已改 | 需重新训练验证 |
| 个体目的地采样 | 待实现 | Phase 2/3 需要修改 |
| 到达终止条件 | 待实现 | Phase 3 需要修改 |
| OD 分布验证 | 待完善 | 需解决尺度匹配问题 |

---

## 5. 改进路线图

### 短期 (本周)
1. [ ] 重新训练 Phase 4 模型 (使用修复后的 normalizer)
2. [ ] 验证 normalizer 修复是否改善 condition sensitivity

### 中期 (2周内)
3. [ ] 实现个体目的地采样 (Phase 2/3 修改)
4. [ ] 添加到达终止条件
5. [ ] 重新生成轨迹数据
6. [ ] 建立基于真实 OD 的验证指标

### 长期
7. [ ] 获取真实轨迹数据
8. [ ] 用真实数据训练 Phase 4
9. [ ] 对比 Phase 3 vs Phase 4 在真实数据上的表现

---

*最后更新: 2024-12-03*
